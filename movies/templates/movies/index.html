{% extends 'base.html' %}
{% load static %}
{% block content %}

  {% comment %} 이미지 클릭했을때 해당 영화 상세페이지로 이동 하기 {% endcomment %}
  <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4">
    <!-- 평점 순 top10 -->
    <div class="d-inline-block mt-5 pt-5">
      <h3 class="text-center text-white">TOP10</h3>
      <div id="top10" class="carousel slide" data-ride="carousel">
        <ol class="carousel-indicators">
          <li data-target="#top10" data-slide-to="0" class="active"></li>
          <li data-target="#top10" data-slide-to="1"></li>
          <li data-target="#top10" data-slide-to="2"></li>
          <li data-target="#top10" data-slide-to="3"></li>
          <li data-target="#top10" data-slide-to="4"></li>
          <li data-target="#top10" data-slide-to="5"></li>
          <li data-target="#top10" data-slide-to="6"></li>
          <li data-target="#top10" data-slide-to="7"></li>
          <li data-target="#top10" data-slide-to="8"></li>
          <li data-target="#top10" data-slide-to="9"></li>
        </ol>
        <div class="carousel-inner">
          {% for top_movie in top_movies %}
            {% if forloop.first %}
            <div class="carousel-item active">
            {% else %}
            <div class="carousel-item">
            {% endif %}
              <img src="http://image.tmdb.org/t/p/w185/{{ top_movie.poster_path }}" class="d-block w-100" alt="...">
              <div class="carousel-caption d-none d-md-block">
                <h5>{{ top_movie.title }}</h5>
                <p>평점 : {{ top_movie.vote_average}}</p>
              </div>
            </div>
          {% endfor %}
        </div>
        <a class="carousel-control-prev" href="#top10" role="button" data-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#top10" role="button" data-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="sr-only">Next</span>
        </a>
      </div>
    </div>

    <!-- 당신 취향 영화 -->
    <div class="d-inline-block mt-5 pt-5">
      <h3 class="text-center text-white">당신 취향</h3>
      <div id="similar10" class="carousel slide" data-ride="carousel">
        <ol class="carousel-indicators">
          <li data-target="#similar10" data-slide-to="0" class="active"></li>
          <li data-target="#similar10" data-slide-to="1"></li>
          <li data-target="#similar10" data-slide-to="2"></li>
          <li data-target="#similar10" data-slide-to="3"></li>
          <li data-target="#similar10" data-slide-to="4"></li>
          <li data-target="#similar10" data-slide-to="5"></li>
          <li data-target="#similar10" data-slide-to="6"></li>
          <li data-target="#similar10" data-slide-to="7"></li>
          <li data-target="#similar10" data-slide-to="8"></li>
          <li data-target="#similar10" data-slide-to="9"></li>
        </ol>
        <div class="carousel-inner">
          {% for similar_movie in similar_movies %}
            {% if forloop.first %}
            <div class="carousel-item active">
            {% else %}
            <div class="carousel-item">
            {% endif %}
              <img src="http://image.tmdb.org/t/p/w185/{{ similar_movie.poster_path }}" class="d-block w-100" alt="...">
              <div class="carousel-caption d-none d-md-block">
                <h5>{{ similar_movie.title }}</h5>
                <p>평점 : {{ similar_movie.vote_average}}</p>
              </div>
            </div>
          {% endfor %}
        </div>
        <a class="carousel-control-prev" href="#similar10" role="button" data-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#similar10" role="button" data-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="sr-only">Next</span>
        </a>
      </div>
    </div>

  
  <!-- 찜한 콘텐츠(수정 전) -->

    <div class="d-inline-block mt-5 pt-5">
      <h3 class="text-center text-white">찜한 콘텐츠</h3>
      <div id="top10" class="carousel slide" data-ride="carousel">
        <ol class="carousel-indicators">
          <li data-target="#top10" data-slide-to="0" class="active"></li>
          <li data-target="#top10" data-slide-to="1"></li>
          <li data-target="#top10" data-slide-to="2"></li>
          <li data-target="#top10" data-slide-to="3"></li>
          <li data-target="#top10" data-slide-to="4"></li>
          <li data-target="#top10" data-slide-to="5"></li>
          <li data-target="#top10" data-slide-to="6"></li>
          <li data-target="#top10" data-slide-to="7"></li>
          <li data-target="#top10" data-slide-to="8"></li>
          <li data-target="#top10" data-slide-to="9"></li>
        </ol>
        <div class="carousel-inner">
          {% for top_movie in top_movies %}
            {% if forloop.first %}
            <div class="carousel-item active">
            {% else %}
            <div class="carousel-item">
            {% endif %}
              <img src="http://image.tmdb.org/t/p/w185/{{ top_movie.poster_path }}" class="d-block w-100" alt="...">
              <div class="carousel-caption d-none d-md-block">
                <h5>{{ top_movie.title }}</h5>
                <p>평점 : {{ top_movie.vote_average}}</p>
              </div>
            </div>
          {% endfor %}
        </div>
        <a class="carousel-control-prev" href="#top10" role="button" data-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#top10" role="button" data-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="sr-only">Next</span>
        </a>
      </div>
    </div>

  <!-- 최신 콘텐츠 -->
    <div class="d-inline-block mt-5 pt-5">
      <h3 class="text-center text-white">최신 콘텐츠</h3>
      <div id="new10" class="carousel slide" data-ride="carousel">
        <ol class="carousel-indicators">
          <li data-target="#new10" data-slide-to="0" class="active"></li>
          <li data-target="#new10" data-slide-to="1"></li>
          <li data-target="#new10" data-slide-to="2"></li>
          <li data-target="#new10" data-slide-to="3"></li>
          <li data-target="#new10" data-slide-to="4"></li>
          <li data-target="#new10" data-slide-to="5"></li>
          <li data-target="#new10" data-slide-to="6"></li>
          <li data-target="#new10" data-slide-to="7"></li>
          <li data-target="#new10" data-slide-to="8"></li>
          <li data-target="#new10" data-slide-to="9"></li>
        </ol>
        <div class="carousel-inner">
          {% for date_movie in date_movies %}
            {% if forloop.first %}
            <div class="carousel-item active">
            {% else %}
            <div class="carousel-item">
            {% endif %}
              <img src="http://image.tmdb.org/t/p/w185/{{ date_movie.poster_path }}" class="d-block w-100" alt="...">
              <div class="carousel-caption d-none d-md-block">
                <h5>{{ date_movie.title }}</h5>
                <p>평점 : {{ date_movie.vote_average}}</p>
              </div>
            </div>
          {% endfor %}
        </div>
        <a class="carousel-control-prev" href="#new10" role="button" data-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#new10" role="button" data-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="sr-only">Next</span>
        </a>
      </div>
    </div>  
  </div>

  <!-- 영화 카드 -->
    <h3 class="text-white mt-5">&ensp;&ensp;&ensp;#전체영화</h3><br>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4">
      {% for movie in movies %}
        <div class="d-flex justify-content-center">
          <figure class="snip1436">
            <img src="http://image.tmdb.org/t/p/w185/{{ movie.poster_path }}" alt="" />
            <figcaption>
                <h4>{{ movie.title }}</h4>
                <p>평점 : {{ movie.vote_average }}</p>
                {% comment %} <p>{{ movie.overview }}</p> {% endcomment %}
                <div class="icons"><a href="#"><i class="ion-chatbubbles"></i></a>
                <a href="{% url 'movies:detail' movie.pk %}">상세보기</a>
                {% comment %} <i class="ion-person-add"></i> {% endcomment %}
                <form id="dibs" method="POST" data-movie-pk="{{ movie.pk }}">
                  {% csrf_token %}
                  {% if request.user in movie.dibs_users.all %}
                    <button class="btn btn-link d-block mx-auto">
                      <i id="dibs-icon-{{ movie.pk }}" class="fas fa-save" style="color:green;"></i>
                    </button>
                  {% else %}
                    <button class="btn btn-link d-block mx-auto">
                      <i id="dibs-icon-{{ movie.pk }}" class="far fa-save" style="color:gray;"></i>
                    </button>                  
                  {% endif %}
                </form>
                <p>
                  <span id="dibs-count-{{ movie.pk }}">
                    {{ movie.dibs_users.all|length }}명이 찜
                  </span>
                </p>
                {% comment %} <i class="ion-heart"></i> {% endcomment %}
                </div>
            </figcaption>
          </figure>
        </div>
      {% endfor %}
    </div>
{% endblock content %}

{% block script %}
  <script>
    const forms = document.querySelectorAll('#dibs')
    // console.log(dibs_btns)
    
    forms.forEach(function (form) {
      form.addEventListener('submit', function (event) {
        event.preventDefault()
        // console.log('찜했다!!!!!')
        // console.log(event.target)
        const moviePk = event.target.dataset.moviePk
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
        const headers = {
          headers: {
            'X-CSRFToken': csrftoken
          },
        }
        axios.post(`/movies/${moviePk}/dibs/`, {}, headers)
          .then(function (res) {
            // console.log(res.data)
            const dibed = res.data.dibed
            console.log(dibed)
            const count = res.data.count
            console.log(count)
            const dibsIcon = document.querySelector(`#dibs-icon-${moviePk}`)

            if (dibed) {
              dibsIcon.style.color = 'green'
              dibsIcon.classList.remove('far')
              dibsIcon.classList.add('fas')
              alert('찜 완료.')
            } else {
              dibsIcon.style.color = 'gray'
              dibsIcon.classList.remove('fas')
              dibsIcon.classList.add('far')
              alert('찜 취소.')
            }

            const dibscount = document.querySelector(`#dibs-count-${moviePk}`)
            dibscount.innerText = `${count}명이 찜`
          })
          .catch(function (err) {
            console.log(err)
          })
      })
    })
  </script>
{% endblock %}